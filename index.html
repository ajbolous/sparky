<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CareerAI | Job Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .glass-panel {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .message-fade {
        animation: fadeIn 0.3s ease-out forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #e2e8f0;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #cbd5e1;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen text-slate-900"
  >
    <div class="max-w-5xl mx-auto flex flex-col h-screen">
      <header class="p-6 flex justify-between items-center">
        <div class="flex items-center gap-2">
          <div
            class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold"
          >
            C
          </div>
          <h1 class="text-xl font-bold tracking-tight text-slate-800">
            CareerSpark<span class="text-indigo-600">AI</span>
          </h1>
        </div>
      </header>

      <main
        id="chat-window"
        class="flex-1 overflow-y-auto px-4 md:px-0 space-y-8 pb-10"
      >
        <div class="flex gap-4 max-w-3xl mx-auto message-fade">
          <div
            class="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex-shrink-0 flex items-center justify-center text-white shadow-lg"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
          </div>
          <div class="space-y-2">
            <p class="text-sm font-semibold text-slate-500 ml-1">Sparky</p>
            <div
              class="bg-white p-5 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 leading-relaxed"
            >
              Ready to find your next move? Tell me what role you're looking for
              and I'll pull the latest LinkedIn posts for you.
            </div>
          </div>
        </div>
      </main>

      <footer class="p-6 bg-transparent">
        <div class="max-w-3xl mx-auto relative group">
          <div
            class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl blur opacity-20 group-focus-within:opacity-40 transition duration-1000"
          ></div>
          <div
            class="relative flex items-center glass-panel rounded-2xl p-2 shadow-xl border border-slate-200"
          >
            <input
              type="text"
              id="user-input"
              placeholder="Describe your dream job..."
              class="flex-1 bg-transparent border-none focus:ring-0 p-4 text-slate-700 placeholder-slate-400"
            />
            <button
              onclick="handleSend()"
              class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl transition-all duration-200 shadow-lg flex items-center justify-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 rotate-90"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 19l9-2-9-18-9 18 9 2zm0 0v-8"
                />
              </svg>
            </button>
          </div>
        </div>
      </footer>
    </div>

    <script>
      const chatWindow = document.getElementById("chat-window");
      const userInput = document.getElementById("user-input");

      const session_id = crypto.randomUUID(); // Generate a unique session ID for the user

      async function handleSend() {
        const query = userInput.value.trim();
        if (!query) return;

        addMessage(query, "user");
        userInput.value = "";

        // Add a "Thinking" indicator
        const loadingId = addLoadingIndicator();

        try {
          const response = await fetch("http://0.0.0.0:8000/get_jobs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              session_id: "default_session",
              message: query,
            }),
          });

          document.getElementById(loadingId).remove();

          if (!response.ok) throw new Error();
          const js_resp = await response.json();
          if ("jobs" in js_resp && js_resp.jobs.length > 0) {
            addMessage(
              js_resp.message + `<br>I found these opportunities:`,
              "bot",
            );
            renderJobTiles(js_resp.jobs);
            return;
          }

          if ("message" in js_resp) {
            addMessage(js_resp.message, "bot");
          }
        } catch (e) {
          if (document.getElementById(loadingId))
            document.getElementById(loadingId).remove();
          addMessage(
            "I'm having trouble connecting to my brain (the server). Is it running?",
            "bot",
          );
        }
      }

      function addMessage(text, sender) {
        const wrapper = document.createElement("div");
        wrapper.className = `flex gap-4 max-w-3xl mx-auto message-fade ${sender === "user" ? "flex-row-reverse" : ""}`;

        const content =
          sender === "user"
            ? `<div class="bg-indigo-600 text-white p-4 rounded-2xl rounded-tr-none shadow-md">${text}</div>`
            : `<div class="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-slate-600 shadow-inner">
                         <div
            class="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex-shrink-0 flex items-center justify-center text-white shadow-lg"
          >
                       <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
        </div>
                   </div>
                   <div class="bg-white p-5 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 text-slate-700">${text}</div>`;

        wrapper.innerHTML = content;
        chatWindow.appendChild(wrapper);
        scrollToBottom();
      }

      function addLoadingIndicator() {
        const id = "loading-" + Date.now();
        const div = document.createElement("div");
        div.id = id;
        div.className = "flex gap-4 max-w-3xl mx-auto animate-pulse";
        div.innerHTML = `<div class="w-10 h-10 rounded-full bg-slate-200"></div><div class="h-10 w-24 bg-slate-200 rounded-2xl"></div>`;
        chatWindow.appendChild(div);
        scrollToBottom();
        return id;
      }

      function renderJobTiles(jobs) {
        const grid = document.createElement("div");
        grid.className =
          "grid grid-cols-1 gap-4 max-w-3xl mx-auto ml-[56px] message-fade";

        jobs.forEach((job) => {
          const id = `details-${job.job_id}`;
          const hasSalary = job.salary_range && job.salary_range !== "N/A";

          grid.innerHTML += `
            <div class="group bg-white border border-slate-200 rounded-2xl overflow-hidden hover:border-indigo-300 hover:shadow-xl transition-all duration-300">
                <div class="p-5">
                    <div class="flex items-start gap-4">
                        <img src="${job.company_logo_url}" class="w-14 h-14 rounded-xl object-contain border border-slate-100 p-1 shadow-sm" 
                             onerror="this.src='https://ui-avatars.com/api/?name=${job.company_name}'">
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-slate-900 truncate group-hover:text-indigo-600 transition-colors">
                                    ${job.job_title}
                                </h3>
                                ${job.easy_apply ? '<span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold">Easy Apply</span>' : ""}
                            </div>
                            <p class="text-indigo-600 font-medium text-sm hover:underline cursor-pointer">
                                <a href="${job.company_url}" target="_blank">${job.company_name}</a>
                            </p>
                            <div class="flex flex-wrap gap-y-1 gap-x-3 mt-2 text-xs text-slate-500">
                                <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/></svg>${job.location}</span>
                                <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/></svg>${job.time_posted}</span>
                                <span class="font-medium text-slate-700">${job.num_applicants}</span>
                            </div>
                        </div>
                    </div>

                    ${
                      hasSalary
                        ? `
                    <div class="mt-4 inline-flex items-center gap-2 bg-slate-50 border border-slate-100 px-3 py-1.5 rounded-lg">
                        <span class="text-xs font-bold text-slate-700">${job.salary_range}</span>
                    </div>`
                        : ""
                    }
                </div>

                <div id="${id}" class="hidden border-t border-slate-50 bg-slate-50/50 p-5 space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-xs">
                        <div>
                            <p class="text-slate-400 uppercase font-bold tracking-widest mb-1">Seniority</p>
                            <p class="text-slate-700 font-medium">${job.seniority_level}</p>
                        </div>
                        <div>
                            <p class="text-slate-400 uppercase font-bold tracking-widest mb-1">Employment</p>
                            <p class="text-slate-700 font-medium">${job.employment_type}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-slate-400 uppercase font-bold tracking-widest mb-1">Industry</p>
                            <p class="text-slate-700 font-medium">${job.industries}</p>
                        </div>
                    </div>
                    <b>Description</b>: ${job.job_description_raw_html}
                </div>

                <div class="flex border-t border-slate-100">
                    <button onclick="toggleDetails('${id}')" class="flex-1 py-3 text-xs font-bold text-slate-500 hover:bg-slate-50 transition border-r border-slate-100">
                        VIEW DETAILS
                    </button>
                    <a href="${job.apply_url || job.job_url}" target="_blank" class="flex-1 py-3 text-xs font-bold text-indigo-600 hover:bg-indigo-50 text-center transition">
                        APPLY NOW
                    </a>
                </div>
            </div>
        `;
        });
        chatWindow.appendChild(grid);
        scrollToBottom();
      }

      // Add this toggle function to your script
      function toggleDetails(id) {
        const el = document.getElementById(id);
        el.classList.toggle("hidden");
      }
      function scrollToBottom() {
        chatWindow.scrollTo({
          top: chatWindow.scrollHeight,
          behavior: "smooth",
        });
      }

      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") handleSend();
      });
    </script>
  </body>
</html>
